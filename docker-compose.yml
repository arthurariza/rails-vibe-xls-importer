x-ruby: &ruby
  build:
    context: .
    dockerfile: ./Dockerfile.dev
    args:
      RUBY_VERSION: "3.4.1"
      NODE_MAJOR: "20"
  environment:
    RAILS_ENV: development
    NODE_ENV: development
    HISTFILE: /usr/local/hist/.bash_history
    IRB_HISTFILE: /usr/local/hist/.irb_history
    EDITOR: vi
    VITE_RUBY_HOST: vite
    YARN_CACHE_FOLDER: /app/node_modules/.yarn-cache
  tmpfs:
    - /tmp
    - /app/tmp/pids
  stdin_open: true
  tty: true
  volumes:
    - .:/app
    - bundle:/usr/local/bundle
    - rails_cache:/app/tmp/cache
    - history:/usr/local/hist

services:
  rails:
    <<: *ruby
    command: >
      sh -c "
        rm -f tmp/pids/server.pid
        bin/rails server -b 0.0.0.0 -p 3000
      "
    depends_on:
      bundler:
        condition: service_completed_successfully
      vite:
        condition: service_started
    ports:
      - "3000:3000"
    env_file:
      - .env

  bundler:
    <<: *ruby
    command: >
      bash -c "
        echo 'Running bundler...';
        bundle --version;
        bundle install;
      "
    volumes:
      - .:/app
      - bundle:/usr/local/bundle

  vite:
    <<: *ruby
    command: >
      sh -c "
        yarn install
        ./bin/vite dev
      "
    depends_on:
      bundler:
        condition: service_completed_successfully
    environment:
      DEBUG: "*vite*"
      VITE_RUBY_HOST: 0.0.0.0
      YARN_CACHE_FOLDER: /app/node_modules/.yarn-cache
    volumes:
      - .:/app
      - bundle:/usr/local/bundle
      - node_modules:/app/node_modules
      - vite_dev:/app/public/vite-dev
      - vite_test:/app/public/vite-test
    ports:
      - "3036:3036"

volumes:
  bundle:
  node_modules:
  history:
  rails_cache:
  vite_dev:
  vite_test:
