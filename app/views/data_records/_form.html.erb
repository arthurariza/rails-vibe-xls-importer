<%= form_with(model: [@import_template, data_record], local: true) do |form| %>
  <% if data_record.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-6">
      <h3 class="text-sm font-medium text-red-800">
        <%= pluralize(data_record.errors.count, "error") %> prohibited this record from being saved:
      </h3>
      <ul class="mt-2 text-sm text-red-700 list-disc pl-5">
        <% data_record.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="space-y-6">
    <!-- Template Information -->
    <div class="bg-gray-50 rounded-lg p-4 mb-6">
      <h3 class="text-lg font-medium text-gray-900 mb-2">Template: <%= @import_template.name %></h3>
      <p class="text-sm text-gray-600"><%= @import_template.description %></p>
    </div>

    <!-- Dynamic Form Fields -->
    <div class="space-y-4">
      <h3 class="text-lg font-medium text-gray-900">Record Data</h3>
      
      <%= form.fields_for :data_record_values do |values_form| %>
        <% @import_template.template_columns.ordered.each do |template_column| %>
          <% existing_value = data_record.data_record_values.find_by(template_column: template_column) %>
          <% current_value = existing_value&.value %>
          
          <%= values_form.fields_for :data_record_values, existing_value || data_record.data_record_values.build(template_column: template_column), 
                                     child_index: template_column.id do |value_form| %>
            <%= value_form.hidden_field :template_column_id, value: template_column.id %>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                <%= template_column.name %>
                <% if template_column.required? %>
                  <span class="text-red-500 ml-1">*</span>
                <% end %>
                <span class="text-gray-500 text-xs">(<%= template_column.data_type.capitalize %>)</span>
              </label>
              
              <% case template_column.data_type %>
              <% when "string" %>
                <%= value_form.text_field :value, 
                    value: current_value,
                    class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",
                    placeholder: "Enter #{template_column.name.downcase}" %>
              <% when "number" %>
                <%= value_form.number_field :value, 
                    value: current_value,
                    class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",
                    step: :any,
                    placeholder: "Enter #{template_column.name.downcase}" %>
              <% when "date" %>
                <%= value_form.date_field :value, 
                    value: current_value,
                    class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" %>
              <% when "boolean" %>
                <div class="flex items-center space-x-3 mt-1">
                  <label class="flex items-center">
                    <%= value_form.radio_button :value, "true", checked: current_value == "true", class: "focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" %>
                    <span class="ml-2 text-sm text-gray-700">Yes</span>
                  </label>
                  <label class="flex items-center">
                    <%= value_form.radio_button :value, "false", checked: current_value == "false", class: "focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" %>
                    <span class="ml-2 text-sm text-gray-700">No</span>
                  </label>
                  <label class="flex items-center">
                    <%= value_form.radio_button :value, "", checked: current_value.blank?, class: "focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" %>
                    <span class="ml-2 text-sm text-gray-700">Not set</span>
                  </label>
                </div>
              <% else %>
                <%= value_form.text_area :value, 
                    value: current_value,
                    rows: 3,
                    class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",
                    placeholder: "Enter #{template_column.name.downcase}" %>
              <% end %>
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <!-- Import Batch ID (optional) -->
    <div>
      <%= form.label :import_batch_id, class: "block text-sm font-medium text-gray-700" %>
      <%= form.text_field :import_batch_id, 
          class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500",
          placeholder: "Optional batch identifier" %>
      <p class="mt-1 text-sm text-gray-500">Use this to group related records together</p>
    </div>

    <!-- Form Actions -->
    <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
      <%= link_to "Cancel", import_template_data_records_path(@import_template), 
          class: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded" %>
      <%= form.submit class: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
    </div>
  </div>
<% end %>